<!DOCTYPE html>
<html lang="en" ng-app="angularApp">
  <head>
    <!-- Page title -->
    <title>Studio Duvet - {% block title %}{% endblock %}</title>
    <meta name="description" content="{% block description %}{% endblock %}"/>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- CSS -->
    {% assets "css_all" %}
      <link rel="stylesheet" href="{{ ASSET_URL }}">
    {% endassets %}
    {% block styles %}{% endblock %}
    <!-- /CSS -->
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!--[if lt IE 10]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/2014.01.31/classList.min.js"></script>
    <![endif]-->
    <meta name="csrf-token" content="{{ csrf_token() }}">
  </head>
  <body ng-controller={% block ng_controller %}"CartController"{% endblock %}>
    {% block fb_oauth_sdk %}{% endblock %}
    <script>
      function statusChangeCallback(response) {
        console.log('fb statusChangeCallback');
        if (response.status === 'connected') {
          console.log("Logged in to fb and authorized");
          fbLogin();
        } else if (response.status === 'not_authorized') {
          console.log("Logged in to fb but not authorized");
        } else {
          console.log("Not logged in to fb");
        }
      };

      function checkLoginState() {
        FB.getLoginStatus(function(response) {
          statusChangeCallback(response);
        });
      };

      window.fbAsyncInit = function() {
        FB.init({
          appId      : '1050879885027789',
          xfbml      : true,
          version    : 'v2.7'
        });
        FB.getLoginStatus(function(response) {
          //statusChangeCallback(response);
        });
      };

      (function(d, s, id){
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {return;}
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));

      function fbLogin() {
        FB.api('/me', {fields:['name','email','picture']},function(response) {
          /*
          var welcomeEl = document.getElementById('fb-welcome');
          var loginEl = document.getElementById('login');
          var welcome = "<img src='" + response['picture'] + "'/>" +
            "<h5>Bem vindo, " + response['name'] + "!</h5>";
          welcomeEl.innerHtml = welcome;
          loginEl.classList.add('hidden');
          welcomeEl.classList.remove('hidden');
          */
          user = {
            name: response['name'],
            email: response['email'],
            oauth: {
              userId: response['id'],
              provider: 'fb',
            }
          };
          console.log(user);
          $.ajax({
            type: "POST",
            url: "{{ url_for('login') }}",
            data: JSON.stringify(user, null, '\t'),
            headers: {
              "Content-Type": 'application/json;charset=UTF-8',
              "X-CSRFToken": csrfToken
            },
            success: function(data) {
              console.log(data);
              window.location.href = data['redirect'];
            },
            error: function(data) {
              console.log(data);
              FB.logout();
            },
          });
        });
      };
    </script>
    {% include 'partials/nav.html' %}
    <!-- Page content -->
    {% block page_content %} {% endblock %}
    <!-- Institucional -->
    <hr>
    <ul id="info" class="list-inline capitalize">
      <li><a href="{{ url_for('about') }}">Quem somos</a></li>
      <li><a href="{{ url_for('returns') }}">Trocas e devoluções</a></li>
      <li><a href="{{ url_for('custom_made') }}">Sob medida</a></li>
      <li><a href="{{ url_for('wash') }}">Lavanderia</a></li>
      <li><a href="{{ url_for('contact') }}">Contato</a></li>
    </ul>
    <hr>
    <!-- Footer -->
    <div id="footer-wrapper">
      <footer class="container-fluid">
        <div id="connect">
          <span id="newsletter">
            <p>Receba nossa newsletter!</p>
            <div class="duvet-input">
              <input type="email" placeholder="e-mail"></input><button><i
                                  class="fa fa-angle-double-right"></i></button>
            </div>
          </span>
          <span id="social">
            <p>Get connected</p>
            <a href="https://www.facebook.com/DuvetStudio/">
              <i class="fa fa-facebook" aria-hidden="true"></i>
            </a>
            <a href="https://www.instagram.com/studioduvet/">
              <i class="fa fa-instagram" aria-hidden="true"></i>
            </a>
          </span>
        </div>
        <div class="engine text-right full-width">
          <p>powered by nscmr&reg</p>
        </div>
      </footer>
    </div>
    <!-- /.container -->
    <!-- JS Files -->
    {% assets "js_base" %}
      <script src="{{ ASSET_URL }}"></script>
    {% endassets %}
    {# Jinja block for adding any other scripts needed by any page
    individually (such as OAuth scripts) #}
    <script>
      var csrfToken = $('meta[name=csrf-token]').attr('content');
    </script>
    <script>
      var addToCartUri = "{{ url_for('add_to_cart') }}";
      var getCartUri = "{{ url_for('cart') }}";
      var addToWishlistUri = "{{ url_for('add_to_wishlist') }}";
    </script>
    {% block angular_script %}
      <script src="{{ url_for('static', filename='js/cart.js') }}"></script>
      <script src="{{ url_for('static', filename='js/cartservice.js') }}"></script>
    {% endblock %}
    {% block scripts %}{% endblock %}
  </body>
</html>
